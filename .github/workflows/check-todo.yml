name: Daily TODO Check

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: {}

jobs:
  check-todo:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check if TODO.md is empty
        id: check-todo
        run: |
          if python3 scripts/check_todo.py; then
            echo "has_content=false" >> $GITHUB_OUTPUT
          else
            echo "has_content=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for completed PRs
        if: steps.check-todo.outputs.has_content == 'true'
        id: check-completed-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for completed TODO automation PRs..."
          
          # Check for merged PRs with todo-automation label (read-only)
          MERGED_PRS=$(gh pr list --state merged --label "todo-automation" --json number,title,mergedAt --limit 10)
          
          if [ "$MERGED_PRS" != "[]" ]; then
            echo "Found merged TODO automation PRs"
            echo "has_completed=true" >> $GITHUB_OUTPUT
            
            # Extract PR numbers for the issue body (format as #123, #456)
            PR_NUMBERS=$(echo "$MERGED_PRS" | jq -r '.[].number' | sed 's/^/#/' | paste -sd ',' - | sed 's/,/, /g')
            echo "pr_numbers=$PR_NUMBERS" >> $GITHUB_OUTPUT
          else
            echo "No merged TODO automation PRs found"
            echo "has_completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for existing TODO issue
        if: steps.check-todo.outputs.has_content == 'true'
        id: check-existing-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing open TODO automation issues..."
          
          # Check for open issues with todo-automation label
          EXISTING_ISSUES=$(gh issue list --label "todo-automation" --state open --json number,title --limit 1)
          
          if [ "$EXISTING_ISSUES" != "[]" ]; then
            ISSUE_NUMBER=$(echo "$EXISTING_ISSUES" | jq -r '.[0].number')
            echo "Found existing open issue #$ISSUE_NUMBER"
            echo "has_existing=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No existing open TODO issue found"
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger GitHub Copilot Workspace
        if: steps.check-todo.outputs.has_content == 'true' && steps.check-existing-issue.outputs.has_existing == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "TODO.md has content - creating issue to trigger GitHub Copilot Workspace"
          
          # Write TODO content to temp file
          TODO_FILE=$(mktemp)
          if [ -f TODO.md ]; then
            cat TODO.md > "$TODO_FILE"
          fi
          
          # Create issue body with proper escaping
          ISSUE_BODY_FILE=$(mktemp)
          cat > "$ISSUE_BODY_FILE" << 'EOF_BODY'
          @copilot /workspace

          Please process the following TODO items from TODO.md and create a PR with the necessary changes:

          ```
          EOF_BODY
          cat "$TODO_FILE" >> "$ISSUE_BODY_FILE"
          cat >> "$ISSUE_BODY_FILE" << 'EOF_FOOTER'
          ```

          After completing the work, please update TODO.md accordingly (remove completed items or mark as done).
          EOF_FOOTER
          
          # Add note about completed PRs if any exist
          if [ "${{ steps.check-completed-prs.outputs.has_completed }}" = "true" ]; then
            cat >> "$ISSUE_BODY_FILE" << 'EOF_COMPLETED'

          **Note:** There are merged PRs with the `todo-automation` label (${{ steps.check-completed-prs.outputs.pr_numbers }}). Please review them and remove any completed items from TODO.md.
          EOF_COMPLETED
          fi
          
          # Create issue to trigger Copilot Workspace
          gh issue create \
            --title "Process TODO.md items - $(date +%Y-%m-%d)" \
            --body-file "$ISSUE_BODY_FILE" \
            --label "copilot-workspace,todo-automation"
          
          # Clean up temp files
          rm -f "$TODO_FILE" "$ISSUE_BODY_FILE"
          
          echo "Issue created with @copilot workspace mention to trigger agent session"
      
      - name: Skip - existing issue found
        if: steps.check-todo.outputs.has_content == 'true' && steps.check-existing-issue.outputs.has_existing == 'true'
        run: |
          echo "Skipping issue creation - existing open TODO issue #${{ steps.check-existing-issue.outputs.issue_number }} found"
