name: Daily TODO Check

on:
  schedule:
    # Run every 12 hours
    - cron: '0 */12 * * *'
  workflow_dispatch: {}

jobs:
  check-todo:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check if TODO.md is empty
        id: check-todo
        run: |
          if python3 scripts/check_todo.py; then
            echo "has_content=false" >> $GITHUB_OUTPUT
          else
            echo "has_content=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for existing TODO issue
        if: steps.check-todo.outputs.has_content == 'true'
        id: check-existing-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing open TODO automation issues..."
          
          # Check for open issues with todo-automation label
          EXISTING_ISSUES=$(gh issue list --label "todo-automation" --state open --json number,title --limit 1)
          
          if [ "$EXISTING_ISSUES" != "[]" ]; then
            ISSUE_NUMBER=$(echo "$EXISTING_ISSUES" | jq -r '.[0].number')
            echo "Found existing open issue #$ISSUE_NUMBER"
            echo "has_existing=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No existing open TODO issue found"
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi

      - name: Log gh availability
        id: gh-check
        if: steps.check-todo.outputs.has_content == 'true'
        run: |
          echo "--- gh CLI debug ---"
          AGENT_AVAILABLE=false
          if command -v gh >/dev/null 2>&1; then
            gh --version || true
            if gh help agent-task >/dev/null 2>&1; then
              echo "gh agent-task: available"
              AGENT_AVAILABLE=true
            else
              echo "gh agent-task: not available"
            fi
          else
            echo "gh: not installed on runner"
          fi
          echo "agent_task_available=$AGENT_AVAILABLE" >> $GITHUB_OUTPUT

      - name: Check for existing TODO PR
        if: steps.check-todo.outputs.has_content == 'true'
        id: check-existing-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing open TODO PRs..."
          # Read a short snippet of TODO.md (if present) to detect PRs that already include the same content
          TODO_SNIP=""
          if [ -f TODO.md ]; then
            TODO_SNIP=$(head -c 300 TODO.md | tr -d '\n' | sed 's/"/\\"/g' )
          fi

          # First check open PRs
          EXISTING_PRS=$(gh pr list --state open --json number,title,author,labels,body --limit 100)
          MATCHING_PR=""
          echo "$EXISTING_PRS" | jq -c '.[]' | while read -r PR; do
            NUM=$(echo "$PR" | jq -r '.number')
            TITLE=$(echo "$PR" | jq -r '.title')
            AUTHOR=$(echo "$PR" | jq -r '.author.login' 2>/dev/null || true)
            LABELS=$(echo "$PR" | jq -r '.labels[]?.name' 2>/dev/null || true)
            BODY=$(echo "$PR" | jq -r '.body' 2>/dev/null || true)

            if [ "${AUTHOR}" = "copilot-swe-agent" ] || echo "$LABELS" | grep -qi "todo-automation" || echo "$TITLE" | grep -qi "Process TODO.md items" || ( [ -n "$TODO_SNIP" ] && echo "$BODY" | grep -Fqi "$TODO_SNIP" ); then
              MATCHING_PR=$NUM
              echo "Found matching open PR #$MATCHING_PR (title: $TITLE, author: $AUTHOR)"
              echo "has_pr=true" >> $GITHUB_OUTPUT
              echo "pr_number=$MATCHING_PR" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # If no matching open PR found, also check recently closed PRs to avoid reopening a closed-but-unmerged Copilot PR
          if [ -z "$MATCHING_PR" ]; then
            CLOSED_PRS=$(gh pr list --state closed --json number,title,author,labels,body --limit 100)
            echo "$CLOSED_PRS" | jq -c '.[]' | while read -r PR; do
              NUM=$(echo "$PR" | jq -r '.number')
              TITLE=$(echo "$PR" | jq -r '.title')
              AUTHOR=$(echo "$PR" | jq -r '.author.login' 2>/dev/null || true)
              LABELS=$(echo "$PR" | jq -r '.labels[]?.name' 2>/dev/null || true)
              BODY=$(echo "$PR" | jq -r '.body' 2>/dev/null || true)

              if [ "${AUTHOR}" = "copilot-swe-agent" ] || echo "$LABELS" | grep -qi "todo-automation" || echo "$TITLE" | grep -qi "Process TODO.md items" || ( [ -n "$TODO_SNIP" ] && echo "$BODY" | grep -Fqi "$TODO_SNIP" ); then
                # Check if PR was merged; skip merged PRs
                MERGED=$(gh pr view $NUM --json merged -q .merged 2>/dev/null || echo "false")
                if [ "$MERGED" = "true" ]; then
                  echo "Skipping merged PR #$NUM"
                  continue
                fi
                MATCHING_PR=$NUM
                echo "Found matching closed (unmerged) PR #$MATCHING_PR (title: $TITLE, author: $AUTHOR)"
                echo "has_pr=true" >> $GITHUB_OUTPUT
                echo "pr_number=$MATCHING_PR" >> $GITHUB_OUTPUT
                exit 0
              fi
            done
          fi

          if [ -z "$MATCHING_PR" ]; then
            echo "No existing open or closed TODO PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
          fi
          if [ -n "$MATCHING_PR" ]; then
            echo "Found existing open TODO PR #$MATCHING_PR"
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$MATCHING_PR" >> $GITHUB_OUTPUT
          else
            echo "No existing open TODO PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare TODO issue body
        id: prepare-issue
        if: steps.check-todo.outputs.has_content == 'true' && steps.check-existing-issue.outputs.has_existing == 'false' && steps.check-existing-pr.outputs.has_pr == 'false'
        run: |
          # Write TODO content to temp file
          TODO_FILE=$(mktemp)
          if [ -f TODO.md ]; then
            cat TODO.md > "$TODO_FILE"
          fi

          # Create issue body with proper escaping
          ISSUE_BODY_FILE=$(mktemp)
          cat > "$ISSUE_BODY_FILE" << 'EOF_BODY'
          @copilot

          Please process the following TODO items from TODO.md and create a PR with the necessary changes.

          Before creating the final commit or PR, run the repository linter and tests and fix any failures:

          - Run the linter: `flake8`
          - Run the test suite: `pytest`

          Only create the final PR/commit when both the linter and tests pass. Include the linter and test results in the PR description or a CI run log.

          Now apply the requested changes for the TODOs below and open a branch+PR when complete:

          ```
          EOF_BODY
          cat "$TODO_FILE" >> "$ISSUE_BODY_FILE"
          cat >> "$ISSUE_BODY_FILE" << 'EOF_FOOTER'
          ```

          After completing the work, please update TODO.md accordingly (remove completed items or mark as done).
          EOF_FOOTER

          # Export file paths for later steps
          echo "todo_file=$TODO_FILE" >> $GITHUB_OUTPUT
          echo "issue_body_file=$ISSUE_BODY_FILE" >> $GITHUB_OUTPUT

      - name: Try gh agent-task (Copilot)
        id: try-agent
        if: steps.gh-check.outputs.agent_task_available == 'true' && steps.check-todo.outputs.has_content == 'true' && steps.check-existing-issue.outputs.has_existing == 'false' && steps.check-existing-pr.outputs.has_pr == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY_FILE=${{ steps.prepare-issue.outputs.issue_body_file }}
          echo "Attempting gh agent-task create using $ISSUE_BODY_FILE"
          if gh agent-task create --repo "$GITHUB_REPOSITORY" --from-file "$ISSUE_BODY_FILE" --follow; then
            echo "agent_created=true" >> $GITHUB_OUTPUT
            echo "Agent task created successfully"
          else
            echo "agent_created=false" >> $GITHUB_OUTPUT
            echo "gh agent-task create failed"
          fi

      - name: Create TODO issue (fallback)
        if: steps.check-todo.outputs.has_content == 'true' && steps.check-existing-issue.outputs.has_existing == 'false' && steps.check-existing-pr.outputs.has_pr == 'false' && steps.try-agent.outputs.agent_created != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating TODO issue (agent task not created)"
          TODO_FILE=${{ steps.prepare-issue.outputs.todo_file }}
          ISSUE_BODY_FILE=${{ steps.prepare-issue.outputs.issue_body_file }}

          # Ensure the 'todo-automation' label exists (create if missing)
          if ! gh label view "todo-automation" >/dev/null 2>&1; then
            echo "Creating missing label 'todo-automation'"
            gh label create "todo-automation" --description "Issues created by TODO automation" --color ffb000 || true
          fi

          # Create issue to trigger Copilot Workspace (apply `todo-automation` label)
          ISSUE_URL=$(gh issue create \
            --title "Process TODO.md items - $(date +%Y-%m-%d)" \
            --body-file "$ISSUE_BODY_FILE" \
            --label "todo-automation" 2>&1) || true
          
          # Extract issue number from URL (format: https://github.com/owner/repo/issues/123)
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed -n 's#.*/issues/\([0-9][0-9]*\).*#\1#p' || true)

          if [ -n "$ISSUE_NUMBER" ]; then
            echo "Created issue #$ISSUE_NUMBER"
            # Try to assign to Copilot bot using GitHub App username
            gh issue edit "$ISSUE_NUMBER" --add-assignee "copilot" || \
            gh issue edit "$ISSUE_NUMBER" --add-assignee "github-copilot[bot]" || \
            echo "Warning: failed to assign Copilot to issue #$ISSUE_NUMBER"
            gh issue comment "$ISSUE_NUMBER" --body "@copilot" || echo "Warning: failed to post Copilot mention on issue #$ISSUE_NUMBER"
          else
            echo "Warning: could not determine created issue number; skipping assignment/comment"
          fi

          # Clean up temp files
          rm -f "$TODO_FILE" "$ISSUE_BODY_FILE"

          echo "Issue created (and assigned/commented when possible) to trigger Copilot if available"
      
      - name: Skip - existing issue or PR found
        if: steps.check-todo.outputs.has_content == 'true' && (steps.check-existing-issue.outputs.has_existing == 'true' || steps.check-existing-pr.outputs.has_pr == 'true')
        run: |
          echo "Skipping issue creation - existing open TODO issue/pr found"
          echo "Existing issue: ${{ steps.check-existing-issue.outputs.issue_number }}"
          echo "Existing PR: ${{ steps.check-existing-pr.outputs.pr_number }}"
