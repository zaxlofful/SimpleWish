name: PR checks (lint & tests)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_run:
    workflows:
      - 'Build and publish CI image'
    types:
      - completed

jobs:
  pr-checks:
    name: Lint and Test (secure Linux runner)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository_owner }}/simplewish-ci:${{ vars.CI_IMAGE_TAG }}
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "Debug: show CI_IMAGE_TAG repository variable"
        run: |
          echo "vars.CI_IMAGE_TAG='${{ vars.CI_IMAGE_TAG }}'"

      # NOTE: image verification/signing has been removed; workflows pin to the SHA-tagged image

      - name: Create venv and install deps
        run: |
          python -m venv .venv
          ./.venv/bin/python -m pip install --upgrade pip
          ./.venv/bin/python -m pip install -r scripts/requirements.txt
          ./.venv/bin/python -m pip install -r scripts/requirements-dev.txt

      - name: Run flake8
        run: |
          ./.venv/bin/flake8 --max-line-length=120

      - name: Run tests
        run: |
          ./.venv/bin/python -m pytest -q
