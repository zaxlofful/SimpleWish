name: Test

on:
  workflow_dispatch: {}
  workflow_run:
    workflows:
      - 'Build and publish CI image'
    types:
      - completed

jobs:
  pytest:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ toLower(github.repository_owner) }}/simplewish-ci:${{ vars.CI_IMAGE_TAG }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      # NOTE: image verification/signing has been removed; workflows pin to the SHA-tagged image

      - name: Create venv and install deps
        run: |
          python -m venv .venv
          ./.venv/bin/python -m pip install --upgrade pip
          ./.venv/bin/python -m pip install -r scripts/requirements.txt
          ./.venv/bin/python -m pip install -r scripts/requirements-dev.txt
      - name: Run tests
        run: |
          ./.venv/bin/python -m pytest -q
