name: Check Links

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: {}

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Links
        id: lychee
        uses: lycheeverse/lychee-action@v2
        with:
          fail: false
      
      - name: Check for existing link check issue
        id: check-existing-issue
        if: steps.lychee.outputs.exit_code != 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing open link check issues..."
          
          # Check for open issues with link-check label
          EXISTING_ISSUES=$(gh issue list --label "link-check" --state open --json number,title --limit 1)
          
          if [ "$EXISTING_ISSUES" != "[]" ]; then
            ISSUE_NUMBER=$(echo "$EXISTING_ISSUES" | jq -r '.[0].number')
            echo "Found existing open issue #$ISSUE_NUMBER"
            echo "has_existing=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No existing open link check issue found"
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Issue From File
        if: steps.lychee.outputs.exit_code != 0 && steps.check-existing-issue.outputs.has_existing == 'false'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: Latest Bad Link Checker Report
          content-filepath: ./lychee/out.md
          labels: link-check