name: pytest

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    # Only run when Python files or dependency lists change
    paths:
      - '**/*.py'
      - 'requirements*.txt'
  pull_request: {}

jobs:
  pytest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      issues: write
    container:
      image: ghcr.io/${{ github.repository_owner }}/simplewish-infra:main
      options: --user 0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create venv with system-site-packages
        run: |
          python -m venv --system-site-packages .venv

      - name: Run tests
        id: pytest
        continue-on-error: true
        run: |
          ./.venv/bin/python -m pytest -q

      - name: Create issue on failure
        if: steps.pytest.outcome == 'failure' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for existing open test failure issues
          EXISTING_ISSUES=$(gh issue list --label "test-failure" --state open --json number --limit 1)
          
          if [ "$EXISTING_ISSUES" != "[]" ]; then
            echo "Existing open test failure issue found, skipping issue creation"
            exit 0
          fi
          
          # Ensure the 'test-failure' label exists
          if ! gh label view "test-failure" >/dev/null 2>&1; then
            echo "Creating missing label 'test-failure'"
            gh label create "test-failure" --description "Issues created by test workflow failures" --color d73a4a || true
          fi
          
          # Create issue body
          ISSUE_BODY_FILE=$(mktemp)
          cat > "$ISSUE_BODY_FILE" << 'EOF'
          ## Test Failure
          
          The pytest test suite has failed on the main branch.
          
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          Please investigate and fix the failing tests.
          
          To reproduce locally:
          ```bash
          python -m pytest
          ```
          EOF
          
          # Create issue
          gh issue create \
            --title "Test failure on main - $(date +%Y-%m-%d)" \
            --body-file "$ISSUE_BODY_FILE" \
            --label "test-failure"
          
          rm -f "$ISSUE_BODY_FILE"

      - name: Fail workflow if pytest failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1